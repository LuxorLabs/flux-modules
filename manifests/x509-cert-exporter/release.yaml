apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: x509-certificate-exporter
  namespace: monitoring
spec:
  interval: 1h
  chart:
    spec:
      chart: x509-certificate-exporter
      version: "3.19.1"
      sourceRef:
        kind: HelmRepository
        name: enix
        namespace: flux-system
  values:
    secretsExporter:
      enabled: false
    prometheusServiceMonitor:
      create: false
    prometheusRules:
      create: false

    hostPathsExporter:
      debugMode: true
      daemonSets:
        control-plane-agent:
          nodeSelector:
            node-role.kubernetes.io/control-plane: ""
          tolerations:
            - effect: NoSchedule
              key: node-role.kubernetes.io/control-plane
              operator: Exists
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          watchFiles:
            # Main PKI certs
            - /etc/kubernetes/pki/apiserver.crt
            - /etc/kubernetes/pki/apiserver-etcd-client.crt
            - /etc/kubernetes/pki/apiserver-kubelet-client.crt
            - /etc/kubernetes/pki/front-proxy-client.crt
            - /etc/kubernetes/pki/ca.crt
            - /etc/kubernetes/pki/front-proxy-ca.crt
            # Etcd PKI certs
            - /etc/kubernetes/pki/etcd/ca.crt
            - /etc/kubernetes/pki/etcd/healthcheck-client.crt
            - /etc/kubernetes/pki/etcd/peer.crt
            - /etc/kubernetes/pki/etcd/server.crt

          watchKubeconfFiles:
            - /etc/kubernetes/admin.conf
            - /etc/kubernetes/controller-manager.conf
            - /etc/kubernetes/scheduler.conf
            - /etc/kubernetes/super-admin.conf

  # postRenderers:
  #   - kustomize:
  #       patches:
  #         - target:
  #             kind: Deployment
  #             name: x509-certificate-exporter
  #           patch: |-
  #             apiVersion: apps/v1
  #             kind: Deployment
  #             metadata:
  #               name: x509-certificate-exporter
  #             spec:
  #               template:
  #                 spec:
  #                   nodeSelector:
  #                     node-role.kubernetes.io/control-plane: ""
  #                   tolerations:
  #                     - effect: NoSchedule
  #                       key: node-role.kubernetes.io/control-plane
  #                       operator: Exists
